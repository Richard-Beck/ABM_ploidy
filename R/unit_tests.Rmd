---
title: "Unit_tests"
output: html_document
date: "2024-04-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load necessary libraries and packages
```{r cars}

library(ggplot2)
library(data.table)
library(tidyverse)
library(dplyr)
library("ggpubr")
library(rgl)
library("spatstat.geom") 
library(plotly)
#install.packages("scatterplot3d") # Install
library("scatterplot3d") # load
#install.packages("collapse")
library(reshape2)
library(Matrix)
library(gtools) 
library(abind)


xDim=200
yDim=200
diploid<-c(2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2)


```



 Spatial- and Karyotype-distance analysis:  cell-to-cell  at one time point
 1.Input data contains cell locations and corresponding karyotype in the form (x,y c1,c2,c3,...,c22) collected at the final time point

```{r pressure, echo=FALSE}

setwd("/Users/4477116/Documents/projects/Ploidy_abm/output")
dir<-"/Users/4477116/Documents/projects/Ploidy_abm/output"

manhattanDistance <- function(vect1, vect2){
  dist <- abs(vect1 - vect2)
  dist <- sum(dist)
  return(dist)
}



read_karyo_data_quadrants=function(path){
cellKaryotypeData<-as.matrix(read.csv(path,header=FALSE))
#Isolate all locations with no cells

m<-which(cellKaryotypeData[,1]==0 & cellKaryotypeData[,2]==0)
if(length(m>0)){
  cellKaryotypeData<-cellKaryotypeData[-m,]
}

colnames(cellKaryotypeData)<-c("x","y",paste0("C",seq(1:22)))


  top_right<- cellKaryotypeData[cellKaryotypeData[,"x"]>100 & cellKaryotypeData[,"y"]>100,]
  top_left<- cellKaryotypeData[cellKaryotypeData[,"x"]<100 & cellKaryotypeData[,"y"]>100,]
  bottom_right<- cellKaryotypeData[cellKaryotypeData[,"x"]>100 & cellKaryotypeData[,"y"]<100,]
  bottom_left<- cellKaryotypeData[cellKaryotypeData[,"x"]<100 & cellKaryotypeData[,"y"]<100,]
  
 
  inputs<-list(top_right, top_left, bottom_right, bottom_left)
  results <- lapply(inputs, space_karyotype_dist)
  
  
 # tr<-space_karyotype_dist(top_right)
 # tl<-space_karyotype_dist(top_left)
 # br<-space_karyotype_dist(bottom_right)
 # bl<-space_karyotype_dist(bottom_left)

#Sample data (Size is too large)
sample_fraction=0.60
#cellKaryotypeData <- cellKaryotypeData[seq(1, nrow(cellKaryotypeData), 4), ]
#cellKaryotypeData <-   cellKaryotypeData[sample(nrow(  cellKaryotypeData), size = round(nrow(  cellKaryotypeData) * sample_fraction)), ]
#cellKaryotypeData <-   cellKaryotypeData[sample(nrow(  cellKaryotypeData), size = 500), ]

              
#Represent data as a n-by-2 matrix whose 1st column contains PAIRWISE spatial dts and 2nd column has corresponding  karyotype dist btn cells

#z2 <- aggregate(list(karyotype_dts=paired_distances_DF$karyotype_dts),
#                by=list(spatial_dts=paired_distances_DF$spatial_dts),
#                function(q){
##                  mean(q==0)
#                })
#result<-list(tr_aggreg=tr,tl_aggreg=tl,br_aggreg=br,bl_aggreg=bl)
return(results)
}




space_karyotype_dist=function(data){
  # Calculate pairwise distances
  spatialDistBtnCells <- dist(data[, 1:2], method = "euclidean", diag = FALSE, upper = FALSE)
  karyotypeDistBtnCells <- dist(data[, 3:24], method = "manhattan", diag = FALSE, upper = FALSE)
  
  paired_distances_DF <- data.frame(
    spatial_dts = as.vector(spatialDistBtnCells),
    karyotype_dts = as.vector(karyotypeDistBtnCells)
  )
  
  z1 <- aggregate(list(karyotype_dts=paired_distances_DF$karyotype_dts),
                  by=list(spatial_dts=paired_distances_DF$spatial_dts),
                  mean)
  
  return(z1)
}




manhattanDistance <- function(vect1, vect2){
  dist <- abs(vect1 - vect2)
  dist <- sum(dist)
  return(dist)
}



ctrl_df<-read_karyo_data_quadrants(paste0(dir,"/300-karyotype_Location.csv"))
cnv_260<-read_karyo_data_quadrants(paste0(dir,"/269-karyotype_Location.csv"))


ctrl_tr_under10<-ctrl_df[[1]][ctrl_df[[1]]$spatial_dts<10,]
ctrl_tl_under10<-ctrl_df[[2]][ctrl_df[[2]]$spatial_dts<10,] 
ctrl_br_under10<-ctrl_df[[3]][ctrl_df[[3]]$spatial_dts<10,]
ctrl_bl_under10<-ctrl_df[[4]][ctrl_df[[4]]$spatial_dts<10,]



cnv_tr_under10<-cnv_260[[1]][cnv_260[[1]]$spatial_dts<10,]
cnv_tl_under10<-cnv_260[[2]][cnv_260[[2]]$spatial_dts<10,] 
cnv_br_under10<-cnv_260[[3]][cnv_260[[3]]$spatial_dts<10,]
cnv_bl_under10<-cnv_260[[4]][cnv_260[[4]]$spatial_dts<10,]


# Plotting
p1 <- ggplot(NULL, aes(x = spatial_dts)) +
  geom_point(data = cnv_tr_under10, mapping = aes(y = karyotype_dts, color = "Cnv"), size = 1.4) +
  geom_point(data = ctrl_tr_under10, mapping = aes(y = karyotype_dts, color = "Ctrl"), size = 1.4) +
  labs(x = NULL, y = NULL)
  
# Plotting
p2 <- ggplot(NULL, aes(x = spatial_dts)) +
  geom_point(data = cnv_tl_under10, mapping = aes(y = karyotype_dts, color = "Cnv"), size = 1.4) +
  geom_point(data = ctrl_tl_under10, mapping = aes(y = karyotype_dts, color = "Ctrlt"), size = 1.4) + 
  labs(x = NULL, y = NULL)

# Plotting
p3 <- ggplot(NULL, aes(x = spatial_dts)) +
  geom_point(data = cnv_br_under10, mapping = aes(y = karyotype_dts, color = "Cnv"), size = 1.4) +
  geom_point(data = ctrl_br_under10, mapping = aes(y = karyotype_dts, color = "Ctrl"), size = 1.4)+ 
  labs(x = NULL, y = NULL)

# Plotting
p4 <- ggplot(NULL, aes(x = spatial_dts)) +
  geom_point(data = cnv_bl_under10, mapping = aes(y = karyotype_dts, color = "CNV"), size = 1.4) +
  geom_point(data = ctrl_bl_under10, mapping = aes(y = karyotype_dts, color = "Ctrl"), size = 1.4) +
  labs(x = NULL, y = NULL)

combined_plot <- ggarrange(
  p2, p1, p4, p3,
  labels = c("A", "B", "C", "D"), # Optional labels for the subplots
  ncol = 2, nrow = 2, # Arrange in a 2x2 grid
  common.legend = TRUE, legend = "bottom" # Common legend at the bottom
)

# Annotate the combined plot with a common title and axis labels
combined_plot <- annotate_figure(
  combined_plot,
  top = text_grob("Cell-to-cell: Spatial vs karyotype distance  (sim. time t=300)", size = 16, face = "bold"),
  bottom = text_grob("Spatial distance", size = 16),
  left = text_grob("Karyotype distance", size = 16, rot = 90)
)

combined_plot





read_karyo_data=function(path){
cellKaryotypeData<-as.matrix(read.csv(path,header=FALSE))
#Isolate all locations with no cells

m<-which(cellKaryotypeData[,1]==0 & cellKaryotypeData[,2]==0)
if(length(m>0)){
  cellKaryotypeData<-cellKaryotypeData[-m,]
}

colnames(cellKaryotypeData)<-c("x","y",paste0("C",seq(1:22)))



#Sample data (Size is too large)
sample_fraction=0.60
#cellKaryotypeData <- cellKaryotypeData[seq(1, nrow(cellKaryotypeData), 4), ]
#cellKaryotypeData <-   cellKaryotypeData[sample(nrow(  cellKaryotypeData), size = round(nrow(  cellKaryotypeData) * sample_fraction)), ]
#cellKaryotypeData <-   cellKaryotypeData[sample(nrow(  cellKaryotypeData), size = 500), ]

              
#Represent data as a n-by-2 matrix whose 1st column contains PAIRWISE spatial dts and 2nd column has corresponding  karyotype dist btn cells

# Calculate pairwise distances
  spatialDistBtnCells <- dist(cellKaryotypeData [, 1:2], method = "euclidean", diag = FALSE, upper = FALSE)
  karyotypeDistBtnCells <- dist(cellKaryotypeData [, 3:24], method = "manhattan", diag = FALSE, upper = FALSE)
  
  paired_distances_DF <- data.frame(
    spatial_dts = as.vector(spatialDistBtnCells),
    karyotype_dts = as.vector(karyotypeDistBtnCells)
  )
  
  z1 <- aggregate(list(karyotype_dts=paired_distances_DF$karyotype_dts),
                  by=list(spatial_dts=paired_distances_DF$spatial_dts),
                  mean)
  
  
#z2 <- aggregate(list(karyotype_dts=paired_distances_DF$karyotype_dts),
#                by=list(spatial_dts=paired_distances_DF$spatial_dts),
#                function(q){
##                  mean(q==0)
#                })
#result<-list(tr_aggreg=tr,tl_aggreg=tl,br_aggreg=br,bl_aggreg=bl)
return(z1)
}

ctrl_df<-read_karyo_data(paste0(dir,"/50-karyotype_Location.csv"))
cnv_260<-read_karyo_data(paste0(dir,"/269-karyotype_Location.csv"))













# Plotting
p2 <- ggplot(NULL, aes(x = spatial_dts)) +
  geom_point(data = ctrl_tr_under10, mapping = aes(y = karyotype_dts, color = "Top right"), size = 1.4) +
  geom_smooth(data = ctrl_tr_under10, mapping = aes(y = karyotype_dts, color = "Top right"), size = 1.4) +
  geom_point(data = ctrl_tl_under10, mapping = aes(y = karyotype_dts, color = "Top left"), size = 1.4) +
  geom_smooth(data = ctrl_tl_under10, mapping = aes(y = karyotype_dts, color = "Top left"), size = 1.4) +
  geom_point(data = ctrl_br_under10, mapping = aes(y = karyotype_dts, color = "Bottom right"), size = 1.4) +
  geom_smooth(data = ctrl_br_under10, mapping = aes(y = karyotype_dts, color = "Bottom right"), size = 1.4) +
  geom_point(data = ctrl_bl_under10, mapping = aes(y = karyotype_dts, color = "Bottom left"), size = 1.4) +
  geom_smooth(data = ctrl_bl_under10, mapping = aes(y = karyotype_dts, color = "Bottom left"),method="loess", size = 1.4) +
  #geom_point(data = cnv_aggregated, mapping = aes(y = karyotype_dts, color = "260_T_cnv_tumor cells"), size = 1) +
  labs(x = "Spatial distance", y = " karyotype distance", title = "Cell-to-cell: Spatial vs karyotype distance \n (sim. time t=50)") +
 theme(
  legend.position = c(0, 1),
  legend.justification = c(0, 1),
  legend.box.just = "left",
  legend.background = element_rect(fill = "gray"),
  legend.text = element_text(size = 12)
  )


p2

#messy


# Plotting
p2 <- ggplot(NULL, aes(x = spatial_dts)) +
  geom_point(data = cnv_tr_under10, mapping = aes(y = karyotype_dts, color = "Top right"), size = 1.4) +
  geom_smooth(data = cnv_tr_under10, mapping = aes(y = karyotype_dts, color = "Top right"), size = 1.4) +
  geom_point(data = cnv_tl_under10, mapping = aes(y = karyotype_dts, color = "Top left"), size = 1.4) +
  geom_smooth(data = cnv_tl_under10, mapping = aes(y = karyotype_dts, color = "Top left"), size = 1.4) +
  geom_point(data = cnv_br_under10, mapping = aes(y = karyotype_dts, color = "Bottom right"), size = 1.4) +
  geom_smooth(data = cnv_br_under10, mapping = aes(y = karyotype_dts, color = "Bottom right"), size = 1.4) +
  geom_point(data = cnv_bl_under10, mapping = aes(y = karyotype_dts, color = "Bottom left"), size = 1.4) +
  geom_smooth(data = cnv_bl_under10, mapping = aes(y = karyotype_dts, color = "Bottom left"),method="loess", size = 1.4) +
  #geom_point(data = cnv_aggregated, mapping = aes(y = karyotype_dts, color = "260_T_cnv_tumor cells"), size = 1) +
  labs(x = "Spatial distance", y = " karyotype distance", title = "Cell-to-cell: Spatial vs karyotype distance \n (sim. time t=50)") +
 theme(
  legend.position = c(0, 1),
  legend.justification = c(0, 1),
  legend.box.just = "left",
  legend.background = element_rect(fill = "gray"),
  legend.text = element_text(size = 12)
  )


p2









correlation<-round(cor(z1$spatial_dts,z1$karyotype_dts),3)
cor_coef<-paste("r =",correlation)

###################

ctrl_under10<-ctrl_df[ctrl_df$spatial_dts<10,]
cnv_under10<-cnv_260[cnv_260$spatial_dts<10,]

cor_ctrl10<-round(cor(ctrl_under10$spatial_dts,ctrl_under10$karyotype_dts),3)
ctrl_cor_coef<-paste("r =",cor_ctrl10)



cor_cnv10<-round(cor(cnv_under10$spatial_dts,cnv_under10$karyotype_dts),3)
cnv_cor_coef<-paste("r =",cor_cnv10)



p2<-ggplot(NULL,aes(x=spatial_dts))+
  geom_point(data=ctrl_under10, mapping=aes(y=karyotype_dts,color="ctrl data"),size=3)+
  geom_point(data=cnv_under10, mapping=aes(y=karyotype_dts,color="260_T_cnv_tumor cells"),size=3)+
  #geom_smooth(data=cnv_under10, mapping=aes(y=karyotype_dts,color="260_T_cnv_tumor cells"),size=1)+
  labs(x="Spatial distance",y="karyotype distance",title="Cell-to-cell: Spatial vs karyotype distance  (sim. time t=50)")+
    
     theme(
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.box.just = "left",
    legend.background = element_rect(fill = "gray"),
    legend.text = element_text(size = 12)
     )

  

  p2+theme(text=element_text(size=14))

  

    
  geom_vline(xintercept=(+10),color="blue",lty=2)+
  geom_smooth(data=ctrl_under10, mapping=aes(y=karyotype_dts,color="ctrl data"))+
  geom_smooth(data=cnv_under10, mapping=aes(y=karyotype_dts,"cnv_tumor cells"))+
  labs(x="Spatial distance (Under 10)",y="Mean karyotype dist.",title=paste("Cell-to-cell: Spatial distance vs       karyotype distance, t=200 \n ","]"))
 
  
p2+theme(text=element_text(size=12))







######################

p1 <- ggplot(z1,aes(x=spatial_dts))+
  geom_point(mapping=aes(y=karyotype_dts,color="Karyo dts"),size=.5)+
  geom_vline(xintercept=(+10),color="blue",lty=2)+
  #geom_text(aes(x=62,y=1.7,label=paste("r =",correlation)))+
  labs(x="Spatial distance",y="Mean karyotype dist.",title=paste("Cell-to-cell: 269_T Spatial distance vs karyotype distance, t=200\n "  ,"(",cor_coef,")"))
p1+theme(text=element_text(size=16))


dist_under10<-z1[z1$spatial_dts<10,]
cor_coef10<-paste("r =",round(cor(dist_under10$spatial_dts,dist_under10$karyotype_dts),3))

p2<-ggplot(dist_under10,aes(x=spatial_dts))+
  geom_point(mapping=aes(y=karyotype_dts,color="Karyo dts"))+
  geom_vline(xintercept=(+10),color="blue",lty=2)+
  geom_smooth(aes(y=karyotype_dts))+
  labs(x="Spatial distance (Under 10)",y="Mean karyotype dist.",title=paste("Cell-to-cell: Spatial distance vs karyotype distance, t=200 \n "  ,"(",cor_coef10,")"))
p2+theme(text=element_text(size=12))




p3 <- ggplot(z2,aes(x=spatial_dts))+
  geom_point(mapping=aes(y=karyotype_dts,color="Karyo dts"))+
  geom_vline(xintercept=(+10),color="blue",lty=2)+
  #geom_text(aes(x=62,y=1.7,label=paste("r =",correlation)))+
  labs(x="Spatial distance",y="prob. that karyotypes x-dist apart are identical",title="Fraction of  karyotypes  identical at a given spatial dist "  )

p3

g<-ggarrange(p1,p2,p3,nrow=2,ncol=2)
annotate_figure(g, top = text_grob("Cell-to-cell: Spatial dist. vs karyotype dist.", 
                                   color = "blue", face = "bold", size = 14))


kmeans_result <- kmeans(paired_distances_DF, 4, 10)
paired_distances_DF$cluster <- as.factor(kmeans_result$cluster)

ggplot(paired_distances_DF, aes(x = spatial_dts, y = karyotype_dts, color = cluster)) +
  geom_point(size = 3) +
  labs(title = "K-means Clustering", x = "Spatial Distance", y = "Karyotype Distance") +
  theme_minimal()



#Normalization with min max
minMax <- function(x) {
  (x - min(x)) / (max(x) - min(x))
}

df<-paired_distances_DF[,1:2]

ndf <- as.data.frame(lapply(df, minMax))
head(ndf)




z11 <- aggregate(list(karyotype_dts=ndf$karyotype_dts),
                by=list(spatial_dts=ndf$spatial_dts),
                mean)

         


ggplot(z1smooth,aes(x=spatial_dts))+
  geom_point(mapping=aes(y=karyotype_dts,color="Karyo dts"))+
  #geom_vline(xintercept=(+10),color="blue",lty=2)+
  #geom_text(aes(x=62,y=1.7,label=paste("r =",correlation)))+
  geom_smooth(mapping=aes(y=karyotype_dts), method='loess')+
  labs(x="Spatial distance",y="prob. that karyotypes x-dist apart are identical",title="Fraction of  karyotypes  identical at a given spatial dist "  )

z111<-z11[which(z11$spatial_dts<.4),]

z1smooth<-z11
z1smooth$spatial_dts  <- stats::filter(z1smooth$spatial_dts, rep(1/5, 5), sides=2)
z1smooth$karyotype_dts  <- stats::filter(z1smooth$karyotype_dts, rep(1/5, 5), sides=2)
```



Response to spatial-karyotype distance correlation to mis-segregation

```{r}

#Correlation values from  simulations with different mis-segregation rates are recorded for real data and random data initialization
cor_randomData<- c(0,0.617,0.36,0.43,0.684,0.716,0.72,0.733,0.723,0.739)
cor_realData <- c(0.978,0.983,0.98,0.982,0.975,0.972,0.963,0.949,0.942,0.94)
mis_rate<-c(0,0.001,0.0015,0.0025,0.05,0.1,0.2,0.3,0.4,0.5)
mis_rate2<-c(0,0.001,0.0015,0.0025,0.005,0.0075,0.01,0.025,0.05,0.075,0.1,0.2,0.3,0.4,0.5)

cor_df<-data.frame(mis_rate)
cor_df$realData<-cor_realData
cor_df$randomData<-cor_randomData

b<-ggplot(cor_df,aes(x=mis_rate))+
  geom_point(mapping=aes(y=realData,color="realData"),size=3)+
  geom_smooth(mapping=aes(y=realData,color="realData"))+
  geom_point(mapping=aes(y=randomData,color="randomData"),size=3)+
  geom_smooth(mapping=aes(y=randomData,color="randomData"),method=NULL,se=FALSE)+
  labs(x="Mis-segregation Rate",y="Correlation coefficient",title=paste("Mis_rate against Space-karyotype dist. correlation"))+
  theme(text=element_text(size=14))
b


```




The next chunk analyses Spatial- and Karyotypic-distances  spot-wise




```{r}

Space_karyo_Data<-as.matrix(read.csv("//Users/4477116/Documents/projects/Ploidy_abm/100_Spatial_karyo_dts.csv",header=FALSE)) # data
Space_karyo_Data<-matrix(as.numeric(Space_karyo_Data[-1,]),ncol=3)

columnNames<-c("Distance_btn_regions","Avg_dts_btn_spots","Max_Karyotype_dts")
colnames(Space_karyo_Data)<-columnNames
Space_karyo_DF<-data.frame(Space_karyo_Data)

#remove rows with N/A data
Space_karyo_DF<-Space_karyo_DF[!is.na(Space_karyo_DF$Avg_dts_btn_spots),]


Space_karyo_DF<-aggregate(list(Max_Karyotype_dts=Space_karyo_DF$Max_Karyotype_dts),
                         by=list(Avg_dts_btn_spots=Space_karyo_DF$Avg_dts_btn_spots),
                         mean)



Space_karyo_DF<-Space_karyo_DF[Space_karyo_DF$Avg_dts_btn_spots<75,]

ggplot(Space_karyo_DF, aes(x=Avg_dts_btn_spots)) +
  geom_point(mapping=aes(y=Max_Karyotype_dts,colour="Max Karyo dts"),size=2)+
  labs(x="Distance between spots", y="Max. Karyotype between spotes",title="Spotwise comparison: Initialized with data, t_n=500")


cor(Space_karyo_DF$Avg_dts_btn_spots,Space_karyo_DF$Max_Karyotype_dts)

r12<-Space_karyo_DF

rdf<-r12
rdf$Avg_dts_btn_spots<-mean(r12$Avg_dts_btn_spots,r12$Avg_dts_btn_spots,r12$Avg_dts_btn_spots)
rdf$Max_Karyotype_dts<-mean(r12$Avg_dts_btn_spots)



ggplot(r12, aes(x=Avg_dts_btn_spots)) +
  geom_point(mapping=aes(y=Max_Karyotype_dts,colour="Max Karyo dts"))+
  geom_smooth(aes(y=Max_Karyotype_dts),method = "lm", se = FALSE)+
  #geom_line(aes(y=Max_Karyotype_dts))+
  labs(x="Distance between spots", y="Max. Karyotype between spotes",title="Spotwise comparison: Initialized with real data, t_n=100")
```


 Vessel distance  vs density and diversity analysis
 Spots are selected and  the density, diversity and distance from nearest  vessel data is collected from each spot
 
 
```{r}


setwd("/Users/4477116/Documents/projects/Ploidy_abm/")


cor_coef<-matrix(0,nrow=44,ncol=5)
df_list<-list() #Hold all distance-density data frame  for all replicates


 for (time in c(100,200)){
 DistanceDensityData<-as.matrix(read.csv(paste0("~/Documents/projects/Ploidy_abm/",                            time,"_DistanceDensity.csv"),header=FALSE))
 
DistanceDensityData<-matrix(as.numeric(DistanceDensityData[-1,]),ncol=6) 
DistanceDensityData<-data.frame(DistanceDensityData)

colnames(DistanceDensityData)<-c("x","y","Avg_spatial_Dist","Density","Diversity","Avg_Karyotype_Dist")

DistanceDensityData$Sites<-seq(1,nrow(DistanceDensityData))

  
DistanceDensityData<-DistanceDensityData[!is.na(DistanceDensityData$Avg_spatial_Dist),] #remove rows with N/A  measurements          
  
  

dd<-ggplot(DistanceDensityData, aes(x=Avg_spatial_Dist)) +
  geom_point(mapping=aes(y=Density,colour="Diversity"))+
  labs(x="Distance from vessel", y="Cell Density/Diversity",title="Density and diveersity at each site, t=100 ") 


df_long <- DistanceDensityData %>%
    select(Sites, Density, Diversity) %>%
    pivot_longer(cols = c(Density, Diversity), names_to = "Measure", values_to = "Value")

dd<-ggplot(df_long, aes(x = factor(Sites), y = Value, fill = Measure)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(values = c("Density" = "red", "Diversity" = "blue")) +
    theme_minimal() +
    labs(title = "Diversity and Density by test Site",
         x = "Sites",
         y = "Size",
         fill = "Measure")

dd+theme(text=element_text(size=14))


df_name <- paste0("DensityDistance_T",time,"_spot",spot,"_2vsls_df")
df_list[[df_name]] <- DistanceDensity_DF


 index <- (time/100 - 1) * 22+ spot
cor_coef[index,1]<-spot
cor_coef[index,2]<-time
cor_coef[index,3]<--cor(DistanceDensity_DF$Avg_spatial_Dist,DistanceDensity_DF$Density)
cor_coef[index,4]<-cor(DistanceDensity_DF$Avg_spatial_Dist,DistanceDensity_DF$Diversity)
cor_coef[index,5]<-cor(DistanceDensity_DF$Avg_spatial_Dist,DistanceDensity_DF$Avg_Karyotype_Dist)


  
}




cor_df<-data.frame(cor_coef)
colnames(cor_df)<-c("spot","time","vssl_dts_density_corr","vssl_dts_diversity_corr","vssl_dts_karyotype_dts_corr" )



#visualize distance density relationship
p0<- ggplot(df_list[[2]], aes(x=Avg_spatial_Dist)) +
  geom_smooth(mapping=aes(y=Density,colour="Density"),method=NULL,se=FALSE,size=1)+
  geom_point(mapping=aes(y=Density,colour="Density"),size=3)+
  #geom_smooth(aes(y=Density,colour="Density"),method=lm, se=FALSE)+
  #geom_smooth(mapping=aes(y=Diversity,colour="Diversity")+
  geom_point(mapping=aes(y=Diversity,colour="Diversity"),size=3)+
  geom_smooth(aes(y=Diversity,color="Diversity"),method=NULL,se=FALSE,size=1)+
  labs(x="Distance from vessel", y="Cell Density/Diversity",title="Distance vs Density/Diversity: (2 vssls) ; RD")
  p0<-p0 + theme(plot.title = element_text(face = "bold", color = "blue",size=13, hjust = 0.5))
  p0<-p0 + theme(axis.title.x = element_text(size = 13), axis.title.y = element_text(size = 13))
  p0



#test for significance that the  correlation coefficeint is significantly greater zero
t_test_result <- t.test(cor_df$vssl_dts_density_corr, mu = 0,alternative="greater")
t_test_result <- t.test(cor_df$vssl_dts_diversity_corr, mu = 0,alternative="less")


p1<-ggplot(cor_df, aes(x=spot)) +
    geom_point(mapping=aes(y=vssl_dts_density_corr,colour="vessl dts-Density "),pch=5,size=3)+
    geom_hline(yintercept=(0.5),color="blue",lty=2,size=1.2)+
    labs(x="Spot", y="Correlation cooefficient",title="Correlation between vessel dts and Density ",color="Corr_coeff")
    p1<-p1 + theme(plot.title = element_text(face = "bold", color = "blue", size=14, hjust = 0.5))
    p1<-p1 + theme(axis.title.x = element_text(size = 14),  axis.title.y = element_text(size = 14))
p1


p2<-ggplot(cor_df, aes(x=spot)) +
    geom_point(mapping=aes(y=vssl_dts_diversity_corr,colour="vessl dts-Diversity "),pch=5,size=3)+
    geom_hline(yintercept=(0),color="blue",lty=2,size=1.2)+
    labs(x="Spot", y="Correlation cooefficient",title="Correlation between vessel dts and population diversity ",color="Corr_coeff",size=3)
    p2<-p2 + theme(plot.title = element_text(face = "bold", color = "blue",size=13, hjust = 0))
    p2<-p2 + theme(axis.title.x = element_text(size = 13), axis.title.y = element_text(size = 13))
  p2


  p3<-ggplot(cor_df, aes(x=spot)) +
      geom_point(mapping=aes(y=vssl_dts_karyotype_dts_corr,colour="vessl dts-Diversity "),pch=5,size=3)+
      geom_hline(yintercept=(0),color="blue",lty=2,size=1.2)+
      labs(x="Spot", y="Correlation cooefficient",title="Correlation between vessel dts and karyotype  dts",color="Corr_coeff",size=3)
      p3<-p3 + theme(plot.title = element_text(face = "bold", color = "blue",size=13, hjust = 0))
      p3<-p3 + theme(axis.title.x = element_text(size = 13), axis.title.y = element_text(size = 13))
 p3
 
 ggplot(cor_df,aes(x=spot))+
   geom_point(aes(y=vssl_dts_density_corr,color=time),size=3)+
    labs(x="Spot", y="Correlation cooefficient",title="Correlation between vessel dts and karyotype dts",color="Corr_coeff",size=3)
   
cor_df %>% 
  gather(key=time, value=vssl_dts_density_corr) %>% 
  ggplot(aes(x=vssl_dts_density_corr,fill=time)) + 
  geom_histogram(position="dodge")


p4<-ggplot(cor_df, aes(x=spot)) +
    geom_point(mapping=aes(y=vssl_dts_diversity_corr,colour="vessl dts-Diversity "),pch=5,size=3)+
    geom_hline(yintercept=(0),color="blue",lty=2,size=1.2)+
  geom_point(mapping=aes(y=vssl_dts_density_corr,colour="vessl dts-Density "),pch=12,size=3)+
  geom_point(mapping=aes(y=vssl_dts_karyotype_dts_corr,colour="vssl_dts_karyotype_dts_corr"),pch=15,size=3)+
    labs(x="Spot", y="Correlation cooefficient",title="Correlation between vessel dts and population diversity ",color="Corr_coeff",size=3)
    p4<-p4 + theme(plot.title = element_text(face = "bold", color = "blue",size=13, hjust = 0))
    p4<-p4 + theme(axis.title.x = element_text(size = 13), axis.title.y = element_text(size = 13))
  p4



  
```

 
 Spatial Autocorrelation: This test the spatial relatedness of karyotype distribution
 Hytpothesis is that spatial close clones are also genetically close
 
 
```{r}

  library(sp)
  library(spdep)
  #Set working direction to load data from
  setwd("/Users/4477116/Documents/projects/ploidy_abm/output")
  
SAData<-as.matrix(read.csv("/Users/4477116/Documents/projects/ploidy_abm/output/201-karyotype_Location.csv",header=FALSE))

#remove empty locations
m=c()
for(i in 1:nrow(SAData)){
  #if both x and y coordinates are zero, then there is no cell there, remove
  if(SAData[i,1]==0 && SAData[i,2]==0){
    #Collect zero indexes
    m<-c(m,i)
  }
}
  SAData<-SAData[-m,]
  
#Extract unique karyotypes in the data
  UniqueKaryotype<-unique(SAData[,3:24])
  unique_index<-seq(1,nrow(UniqueKaryotype))
  UniqueKaryotype<-cbind(unique_index,UniqueKaryotype) #assign unique index to each unique karyotype

  featureData<-matrix(nrow=nrow(SAData),ncol=3)# holds cell location (x,y) and unique attribute (karyotype identifier)
  featureData[,1:2]<-SAData[,1:2]
  
  for(k in 1:nrow(SAData)){
    for(j in 1:nrow(UniqueKaryotype)){
      if(identical(SAData[k,3:24],UniqueKaryotype[j,2:23])){
        featureData[k,3]<-UniqueKaryotype[j,1]
        break
      }
    }
  }
  
df<-data.frame(featureData)
  
ggplot(df, aes(x = X1,y=X2))+
  geom_point(aes(color=X3))+
  labs(x="xDim",y="yDim")

#set longitude and latittude values for define=ing polygons







# Define the coordinates for each point (x, y)
points <- cbind(df$X1, df$X2)  # Example coordinates

# Create a list to store Polygons objects
polygons <- vector("list", length = nrow(points))

# Create Polygons objects for each point
for (i in 1:nrow(points)) {
  point <- points[i, ]
  polygon <- Polygons(list(Polygon(matrix(point, nrow = 1))), ID = as.character(i))
  polygons[[i]] <- polygon
}

# Create a SpatialPolygons object from the list of Polygons objects
spatial_polygons <- SpatialPolygons(polygons)

# Plot the polygons
#plot(spatial_polygons, col = rainbow(nrow(points)), main = "Polygons with Single Points")

plot(spatial_polygons, border = "red", lwd = 2, main = "Edges of Polygons Defined by Single Points/cell locations")

#Fill inside of polygons
for(i in 1:nrow(points)){
  points(points[i,1], points[i,2], col = "purple", pch = 20)  # Plot the single point
}



#Adding the desired attribute
spatial_polygons$karyo<-df$X3

#spatial_polygons<-df
# Define a distance threshold for neighbors
distance_threshold <- 1 

# Compute neighbors based on distance
nb <- knn2nb(knearneigh(coordinates(spatial_polygons), k = 1))

# Adjust neighbors based on distance threshold
nb <- dnearneigh(coordinates(spatial_polygons), 0, distance_threshold)

# Construct spatial weights matrix
w <- nb2listw(nb, style = "B")

# Perform Moran's test (example)
# Assuming you have a variable 'karyo' associated with each point

moran_result <- moran.test(spatial_polygons$karyo, listw = w)

# View the Moran's test results
print(moran_result)

#Extract the spatially lagged values for each region
spatial_polygons$lag <- lag.listw(w, spatial_polygons$karyo)

#Plot lagged values against karyotype numbers
M <- lm(lag ~ karyo, spatial_polygons)

plot( lag ~ karyo, spatial_polygons, xlim=c(-5,200),pch=21, las=1,  col = "grey40", bg="grey80",
      main="Attribute: Karyotype vs spatially Lagged values",xlab="Karyotype",ylab="spatially lagged values")
 abline(M, col="blue",lwd=3) # Add the regression line from model M
 abline(v = mean(spatial_polygons$karyo), lty=5, col = "green")
 abline(h = mean(spatial_polygons$karyo), lty=5, col = "red")
 legend(150, 500, legend=c("Reg", "Mean karyotype"),
        col=c("blue", "red"), lty=1:2, cex=0.7)
 
 #Computing Moran's coefficient
 moran(spatial_polygons$karyo, listw = w, n = length(nb), S0 = Szero(w))
 
 #Test for significance : Monte carlo 
 MC<- moran.mc(spatial_polygons$karyo, w, nsim = 999)
 MC
 plot(MC,col="red",main="",xlab="Karyotype",las=1)
 
 
```

 Cancer vs normal cells


```{r}
setwd("/Users/4477116/Documents/projects/ploidy_abm/output")
maindir<-"/Users/4477116/Documents/projects/Ploidy_abm/output"

normalize <- function(x) {
  return((x - min(x)) / (max(x) - min(x)))
}



readPopData=function(mypath){

#cell_df<-as.matrix(read.csv("/Users/4477116/Documents/projects/Ploidy_abm/output/10_PopSize.csv",header=FALSE))

cell_df<-as.matrix(read.csv(mypath,header=FALSE))

cell_df<-as.data.frame(cell_df)

colnames(cell_df)<-as.character(cell_df[1,])
cell_df<-cell_df[-1,]

cell_df<-data.frame(lapply(cell_df,as.numeric))
cell_df[is.na(cell_df)]<-0
cell_df<-cell_df[-1,]
cell_df$avg_oxygen<-cell_df$oxygen/40000
#cell_df$oxygen<-cell_df$oxygen/(40000*200)

cell_df$turnOver<-(cell_df$Divisions+cell_df$Deaths)/cell_df$Population
cell_df$turnOver2<-(cell_df$Divisions-cell_df$Deaths)/cell_df$Population
cell_df$NormalTurnOver<-cell_df$N_divRate/cell_df$N_deathRate # Effective proliferation / effective death
cell_df$CancerTurnOver<-cell_df$C_divRate/cell_df$C_deathRate 
cell_df$TotalTurnOver<-(cell_df$N_divRate+cell_df$C_divRate)/(cell_df$N_deathRate+cell_df$C_deathRate)

cell_norm<-cell_df
cell_norm$Population <-normalize(cell_df$Population)
cell_norm$oxygen<-normalize(cell_df$oxygen)
return( list(cell_df=cell_df,cell_norm=cell_norm) )
}



pop_df<-readPopData(paste0(maindir,"/4000_PopSize.csv")) 
cell_df<-pop_df$cell_df
cell_df<-cell_df[-nrow(cell_df),]

cell_df<-cell_df[1:nrow(cell_df)-1,]
cell_norm<-pop_df$cell_norm





df_b20000<-readPopData(paste0(maindir,"/3500_O2_PopSize.csv"))
df_b15000<-readPopData(paste0(maindir,"/1000_O2_PopSize.csv"))
df_b10000<-readPopData(paste0(maindir,"/500_O2_PopSize.csv"))
df_b8000<-readPopData(paste0(maindir,"/300_O2_PopSize.csv"))
df_b8000<-readPopData(paste0(maindir,"/300_O2_PopSize.csv"))



pop_df<-readPopData(paste0(maindir,"/50002_PopSize.csv")) 
cell_df<-pop_df$cell_df
cell_norm<-pop_df$cell_norm

 p0<-ggplot(NULL, aes(x = Time)) +
    geom_line(data=cell_norm,mapping = aes(y = Population, color = "Total_pop."), size = 1) +
   # geom_line(data=O2_norm,mapping=aes(y=O2_conc,color="Oxygen"),size=1)+
    geom_line(data=cell_norm,mapping=aes(y=oxygen, color="Oxygen"),size=1)+
  labs(x = "Time", y = " Population/Oxygen Conc", title="Normalized Population and Oxygen")+
 theme(text=element_text(size=16))


 
 p<-ggplot(cell_df, aes(x = Time)) +
    geom_line(mapping = aes(y = Population), color = "red", size = 1) +
  labs(x = "Time", y = " Population Size", title = "Population" )+
  theme(text=element_text(size=16))+
  xlim(0, 1500) +      # Set x-axis limits
  ylim(5000, 35000)   
 
 
 cell_df <- cell_df %>%
  group_by(Time) %>%
  mutate(
    AdjustedTime = Time + (seq_along(Time) - (n() + 1) / 2) * (1 / (2 * n()))
  )

 o<-ggplot(cell_df, aes(x=Time)) +
  geom_line(mapping=aes(y=oxygen),color="purple",linewidth=1)+
  #geom_vline(xintercept=1,linetype="dashed",color="red",size=.8)+
  labs(x="Time (days)", y="Total oxygen conc. (amoles)",title="Oxygen")+
 theme(text=element_text(size=16))
   
   
    xlim(0, 1500) +      # Set x-axis limits
  ylim(5000, 35000) 
 
   scale_x_continuous(breaks = seq(0, 10,by=1))
 


  
 
 
 combined<-ggarrange(p,o,t,t1,
                      #labels = c("Population","Oxygen ","Net Growth ","Turnover "), #"Growth", "Death", "Popuation","Oxygen"), # Optional labels for the subplots
                      ncol = 2, nrow = 2, # Arrange in a 2x2 grid
                       label.x = 0, # Horizontal position of the labels (centered)
                     label.y = .8,
  common.legend = FALSE
)
 
 
 p1<-ggplot(cell_df, aes(x = Time)) +
  geom_line(mapping = aes(y = N_divRate, color = "Normal"), linewidth = 1) +
  geom_line(mapping = aes(y = C_divRate, color = "Cancer"), linewidth = 1) +
  labs(x = "Time", y = " Average Division Rate", title = "Effective Proliferation rate",color="Division rate") +
   theme(text=element_text(size=16))
  
  p2<-ggplot(cell_df, aes(x = Time)) +
     geom_point(mapping = aes(y = N_deathRate, color = "Normal Death."),size = 1) +
     geom_point(mapping = aes(y = C_deathRate, color = "Cancer Death."), size = 1) +
   labs(x = "Time", y = " Average Death Rate", title = "Effective Death rate",color= " Death rate") 
  
   p1+ theme(text=element_text(size=16))
  
   p3<-ggplot(cell_df, aes(x = Time)) +
    geom_line(mapping = aes(y = N_pop, color = "Normal"), size = 1) +
    geom_line(mapping = aes(y = C_pop, color = "Cancer"), size = 1) +
  labs(x = "Time", y = "Size", title = "Cancer Cell populations",color="Size")+
   theme(text=element_text(size=16))+
       xlim(0, 3000) +      # Set x-axis limits
     ylim(0, 200) 
   
   
    xx<-cell_df
   xx$O2_decrease<-1000-cell_df$C_pop
   p4<-ggplot(xx, aes(x = Time)) +
    #geom_line(mapping = aes(y = N_pop, color = "Normal"), size = 1) +
    geom_line(mapping = aes(y = O2_decrease, color = "O2"), size = 1) +
    labs(x = "Time", y = "Size", title = "Oxygen at Cancer cell spot",color="Size")+
    theme(text=element_text(size=16))
   
   +
    xlim(0, 3000) +      # Set x-axis limits
    ylim(0, 200) 
   
   
   
    t<-ggplot(cell_df, aes(x = Time)) +
    geom_line(mapping = aes(y = turnOver2), color="red",size = 1) +
  labs(x = "Time", y = " Turnover", title = "Turnover rate (Net Growth)")+
      theme(text=element_text(size=14))

   
  
  
  
t1<-ggplot(cell_df, aes(x = Time)) +
    geom_line(mapping = aes(y = NormalTurnOver, color = "Normal"), size = 1) +
    #geom_line(mapping = aes(y = CancerTurnOver, color = "Cancer"), size = 1) +
    geom_line(mapping = aes(y = TotalTurnOver, color = "Total"), size = 1) +
  labs(x = "Time", y = " Turnover Rate", title = "Turnover Rates",color= " Rate") +
  theme(text=element_text(size=14))






combined<-ggarrange(p0,p,o,p1, p2,p3,t1,
                      #labels = c(" "," "," "," "," "," "), #"Growth", "Death", "Popuation","Oxygen"), # Optional labels for the subplots
                      ncol = 2, nrow = 4, # Arrange in a 2x2 grid
                       label.x = 0, # Horizontal position of the labels (centered)
                     label.y = .8,
  common.legend = FALSE
)


################################################################################
####### Test: Dynamic oxygen diffusion run based on    #######################
####### max oxygen gradient across all sites     #######################
################################################################################
mainDir<-"/Users/4477116/Documents/projects/Ploidy_abm/"


delta_df<-read.csv(paste0(mainDir,"output/deltas_scaled.csv"),header=FALSE)

colnames(delta_df)<-as.character(delta_df[1,])
delta_df<-data.frame(delta_df[-1,])%>%
  mutate(across(everything(),as.numeric)) %>%
    group_by(Time) %>%
    mutate(
      #AdjustedTime = Time + (seq_along(Time) - mean(seq_along(Time))) * (1 / (n() * 3)) 
    AdjustedTime = Time + (seq_along(Time) - (n()-1) / 2) * (1 / (1 * n()))
  )

vessels<-read.csv(paste0(mainDir,"input/vessels.txt"),sep="\t",header=FALSE)
colnames(vessels)<-c("x","y")
vessels<-vessels+1 #adjusting for the indexing scheme use in java which starts from 0 instead of 1


dv<-ggplot(NULL, aes(x = x)) +
      geom_point(data=delta_df, mapping=aes(y=y, color="max_delta loc"),size=5) +
      geom_point(data=vessels, mapping=aes(y=y, color="Vessel"),size=2) +
  labs(title = "Maximum Delta locations vs  vessel Sites ",
       x = "X",
       y = "Y",
       color = "Location") +
    theme(text = element_text(size = 16))

nrow(delta_df)
#delta_df$max_delta<-log(delta_df$max_delta)
#Plot max delta value over simulation period
md<-ggplot(delta_df, aes(x = AdjustedTime)) +
      geom_point( mapping=aes(y=max_delta),color="purple",size=0.5) +
     #geom_smooth( mapping=aes(y=max_delta),method = "loess", color = "red", se = FALSE) + 
     #geom_hline(yintercept=250,color="red",linewidth=1)+
  labs(title = "Maximum Delta  ",
       x = "Time (days)",
       y = "Max delta") +
    theme(text = element_text(size = 16))

+
    xlim(0, 6) +      # Set x-axis limits
  ylim(0, 0.015) 


#Count how many simulations were run each day to get that stabilizing value
count_df <- delta_df %>%
  group_by(Time) %>%
  summarise(count = n())
#add diffusion time step to see the actual numbe of simulations
count_df$count<-(count_df$count)+100; 

cn<-ggplot(count_df, aes(x = Time)) +
      geom_point( mapping=aes(y=count),color="purple",size=1) +
  labs(title = "Total  Diffusion/Consumption Simulations Per Day",
       x = "Time (Days)",
       y = "Number of simulations")+
    theme(text = element_text(size = 16))

#Load those maximum deltas including those at vessel ssite
deltav_df<-read.csv(paste0(mainDir,"output/20000_deltas.csv"),header=FALSE)
  colnames(deltav_df)<-as.character(deltav_df[1,])
  

deltav_df<-data.frame(deltav_df[-1,])%>%
  mutate(across(everything(),as.numeric)) %>%
    group_by(Time) %>%
    mutate(
    AdjustedTime = Time + (seq_along(Time) - (n() + 1) / 2) * (1/ ( n()))
  )

#Plot max delta value over simulation period
md1<-ggplot(deltav_df, aes(x = AdjustedTime)) +
      geom_point( mapping=aes(y=max_delta),color="purple",size=.5) +
      #geom_hline(yintercept=250,color="red",linewidth=1)+
  labs(title = "Maximum Delta  ",
       x = "Time",
       y = "Max delta") +
    theme(text = element_text(size = 16))


#Plot max delta value over simulation period 
md2<-ggplot(NULL, aes(x = AdjustedTime)) +
      geom_point(data=delta_df, mapping=aes(y=max_delta,color="-vssl sites"),size=.5) +
      geom_point(data=deltav_df, mapping=aes(y=max_delta,color="+vssl sites"),size=.5) +
      #geom_hline(yintercept=250,color="red",linewidth=1)+
  labs(title = "Maximum Delta  ",
       x = "Time",
       y = "Max delta") +
    theme(text = element_text(size = 16))


#Count hoe=w many timepoints reached equilibrium


df_summary <- delta_df %>%
  group_by(Time) %>%
  summarize(Eq_reached_at_time = ifelse(sum(Eq_reached) > 0, "Yes", "No"))

# Count the number of Yes/No occurrences
df_count <- df_summary %>%
  group_by(Eq_reached_at_time) %>%
  summarize(count = n())

# Plot the bar chart
fr<-ggplot(df_count, aes(x = Eq_reached_at_time, y = count,fill = Eq_reached_at_time)) +
  geom_bar(stat = "identity") +
  labs(x = "Eq_reached (Yes/No)", y = "Number of Time Points", title = "Time Points Where Equilibrium was Reached") +
  scale_fill_manual(values = c("No" = "red", "Yes" = "blue")) +
  theme_minimal()





#Plot  max delta values for different max runs same threshold
dm<-ggplot(NULL, aes(x = AdjustedTime)) +
    geom_point(delta_df, mapping=aes(y=max_delta,color="100"),size=.5) +
   # geom_smooth(delta_df, mapping=aes(y=max_delta),method = "loess", color = "red", se = FALSE) + 
    geom_point(df1000, mapping=aes(y=max_delta,color="1000"),size=.5) +
    geom_point(df10002, mapping=aes(y=max_delta,color="500"),size=.5) +
   geom_point(df200, mapping=aes(y=max_delta,color="200"),size=.5) +
  # geom_smooth(df1000, mapping=aes(y=max_delta),method = "loess", color = "red", se = FALSE)
    labs(title = "Maximum Delta for different Number of Runs  ",
         x = "Time",
         y = "Max delta",
         color="Max.Run") +
    theme(text = element_text(size = 14))

###############################################################################
###############################################################################




################################################################################
############# The following is used to test for times it takes for #############
 ############ level to achieve equilibrium with  different  ####################
 ############ boundary values. ##################################################
################################################################################

#Files have naming convention of BdValue_PopSize.csv
file_list<-list.files("/Users/4477116/Documents/projects/Ploidy_abm/output", pattern="PopSize *\\.csv$",full.names = TRUE)
file_list<-file_list[order(as.numeric(sub("([0-9]*).*","\\4",file_list)))]
all_pop<-list()
for( fileName in file_list){
  popi<-readPopData(fileName) 
 
  
file_name <- basename(fileName)
numeric_parts <- gsub("^([0-9]+)_.*", "\\1", file_name)
print(as.numeric(numeric_parts))
popi$cell_df$oxygen<- popi$cell_df$oxygen/(40000*as.numeric(numeric_parts))
 name<-paste("BD_value_",numeric_parts)
all_pop[[name]] = popi
}


names<-names(all_pop)

allplot<-ggplot(NULL, aes(x=Time))+
  geom_line(data=all_pop[[1]]$cell_df, mapping=aes(y=oxygen, color=names[1]),linewidth=1)+
  geom_line(data=all_pop[[2]]$cell_df, mapping=aes(y=oxygen, color=names[2]),linewidth=1)+
  geom_line(data=all_pop[[3]]$cell_df, mapping=aes(y=oxygen, color=names[3]),linewidth=1)+
  geom_line(data=all_pop[[4]]$cell_df, mapping=aes(y=oxygen, color=names[4]),linewidth=1)+
  geom_line(data=all_pop[[5]]$cell_df, mapping=aes(y=oxygen, color=names[5]),linewidth=1)+
  #geom_line(data=all_pop[[6]]$cell_df, mapping=aes(y=oxygen, color=names[6]),linewidth=1)+
  #geom_line(data=all_pop[[7]]$cell_df, mapping=aes(y=oxygen, color=names[7]),linewidth=1)+
  #geom_line(data=all_pop[[8]]$cell_df, mapping=aes(y=oxygen, color=names[8]),linewidth=1)+
 # geom_line(data=all_pop[[9]]$cell_df, mapping=aes(y=oxygen, color=names[9]),linewidth=1)+
  #geom_line(data=all_pop[[10]]$cell_df, mapping=aes(y=oxygen, color=names[10]),linewidth=1)+
  #geom_line(data=all_pop[[11]]$cell_df, mapping=aes(y=oxygen, color=names[11]),linewidth=1)+
  labs(x="Time", y="Total oxygen conc.(amoles)",title=" Oxygen profile with consumption",color="Boundary value")+
   scale_color_manual(values = c("red",  "darkblue",  "blue", "darkgreen",  "green",   "purple",  "violet",  "yellow",  "orange"),
   breaks = c(names[1], names[2], names[3], names[4], names[5], names[6], names[7], names[8], names[9]))+
  theme(text=element_text(size=14))+
    xlim(0, 1000) +      # Set x-axis limits
   ylim(0, 1)




allpopplot<-ggplot(NULL, aes(x=Time))+
  geom_line(data=all_pop[[1]]$cell_df, mapping=aes(y=Population, color=names[1]),linewidth=1)+
  geom_line(data=all_pop[[2]]$cell_df, mapping=aes(y=Population, color=names[2]),linewidth=1)+
  geom_line(data=all_pop[[3]]$cell_df, mapping=aes(y=Population, color=names[3]),linewidth=1)+
  geom_line(data=all_pop[[4]]$cell_df, mapping=aes(y=Population, color=names[4]),linewidth=1)+
  geom_line(data=all_pop[[5]]$cell_df, mapping=aes(y=Population, color=names[5]),linewidth=1)+
  #geom_line(data=all_pop[[6]]$cell_df, mapping=aes(y=Population, color=names[6]),linewidth=1)+
  # #geom_line(data=all_pop[[7]]$cell_df, mapping=aes(y=Population, color=names[7]),linewidth=1)+
 # geom_line(data=all_pop[[8]]$cell_df, mapping=aes(y=Population, color=names[8]),linewidth=1)+
 # geom_line(data=all_pop[[9]]$cell_df, mapping=aes(y=Population, color=names[9]),linewidth=1)+
  #geom_line(data=all_pop[[10]]$cell_df, mapping=aes(y=oxygen, color=names[10]),linewidth=1)+
  #geom_line(data=all_pop[[11]]$cell_df, mapping=aes(y=oxygen, color=names[11]),linewidth=1)+
  labs(x="Time", y="Total population",title="Response of population time to Boundary oxygen values", color="Boundary value")+
   scale_color_manual(values = c("red",  "darkblue",  "blue", "darkgreen",  "green",   "purple",  "violet",  "yellow",  "orange"),
   breaks = c(names[1], names[2], names[3], names[4], names[5], names[6], names[7], names[8], names[9]))




################################################################################
############# This block test the hypothesis that final population #############
 ############ size differs significantly for different initial conditions  #####
 ############starting with vessel boundary values. #############################
################################################################################




#Files have naming convention of BdValue_PopSize.csv
file_list<-list.files("/Users/4477116/Documents/projects/Ploidy_abm/output", pattern="PopSize *\\.csv$",full.names = TRUE)
#file_list<-file_list[order(as.numeric(gsub("([0-9]+).*","\\1",file_list)))]
all_pop<-data.frame()
final_sizes <- data.frame(OxygenLevel = integer(), FinalPopulation = numeric())


for( fileName in file_list){
  popi<-readPopData(fileName) 
  popi<- popi$cell_df[,c("Time","Population","oxygen")]
  
file_name <- basename(fileName)
numeric_parts <- gsub("^([0-9]+)_.*", "\\1", file_name)
print(as.numeric(numeric_parts))
 name<-paste("BD_value_",numeric_parts)

 popi$BV<-as.numeric(numeric_parts)
final_sizes <- rbind(final_sizes,data.frame(BV =as.numeric(numeric_parts) ,Population = tail(popi$Population,1)))
all_pop<-rbind(all_pop,popi)
}

all_pop$Time<-as.numeric(as.factor(all_pop$Time))

anova_model <- aov(Population ~ factor(BV), data = all_pop)
summary(anova_model)




 pb<-ggplot(final_sizes, aes(x = factor(BV), y =Population, fill = factor(BV))) +
   geom_bar(stat = "identity", color = "black") +
   theme_minimal() +
    labs(x = "Vessel Boundary value", y = "Final Population Size", title = "Final Population Size Over Different BVs")+
    theme(text=element_text(size=16))

   

# Visualizing Population over Time by BV
p<-ggplot(all_pop, aes(x = Time, y = Population, group = BV, color = as.factor(BV))) +
  geom_line(linewidth=1) +
  labs(title = "Population Size Over Time for Different BVs", x = "Time", y = "Population Size", color = "BV Level")+
  theme(text=element_text(size=16))

# Visualizing Population over Time by BV
o<-ggplot(all_pop, aes(x = Time, y = oxygen, group = BV, color = as.factor(BV))) +
  geom_line(linewidth=1) +
  labs(title = "Oxygen profile Over Time for Different BVs", x = "Time", y = "oxygen", color = "BV")+
  theme(text=element_text(size=16))


all_pop$Time_scaled <- scale(all_pop$Time)
all_pop$Population_scaled<-scale(all_pop$Population)
all_pop$BV_scaled<-scale(all_pop$BV)
# Fit the model
model <- lmer(Population_scaled ~ Time_scaled + BV_scaled + (1|BV_scaled), data = all_pop)

model <- lmer(Population ~ Time + BV_scaled + (1|BV_scaled), data = all_pop)

# Check the summary of the model
summary(model)


combined_dat <- do.call(rbind, lapply(seq_along(all_pop), function(i) {
  cbind(all_pop[[i]], ResourceID = unique(all_pop[[i]]$BV))
}))

# Order the combined data frame by ResourceID and Time
combined_dat <- combined_dat[order(combined_dat$ResourceID, combined_dat$Time),]

# Optional: If you want to drop the original 'resources' column assuming it's redundant
combined_dat$resources <- NULL

# View the combined data frame
head(combined_dat)





################################################################################
##############################.                    #############################
################################################################################



 ########################################################################################
#### To test population and oxygen homeostasis  ########################################
###First, we see how population  and oxygen vary with respect to initial population size# 
#########################################################################################

mainDir<-"/Users/4477116/Documents/projects/Ploidy_abm/output/K3"
#Files have naming convention of BdValue_PopSize.csv
file_list<-list.files(mainDir, pattern="PopSize *\\.csv$",full.names = TRUE)
file_list<-file_list[order(as.numeric(sub("([0-9]*).*","\\4",file_list)))]
all_pop<-data.frame()

for( fileName in file_list){
  popi<-readPopData(fileName) 
 
  popi<-popi$cell_df[1:500,]

numeric_parts <- as.numeric(gsub("^([0-9]+)_.*", "\\1", basename(fileName)))
print(as.numeric(numeric_parts))
#popi$cell_df$oxygen<- popi$cell_df$oxygen/(40000*as.numeric(numeric_parts))
 name<-paste("BD_value_",numeric_parts)
popi$init_pop = numeric_parts
all_pop<-rbind(all_pop,popi)
}





o <- ggplot(all_pop, aes(x = Time, y = oxygen, color = as.factor(init_pop))) +
  geom_line(linewidth=1) +
  labs(title = "Oxygen Levels Over Time",
       x = "Time (days)",
       y = "Total Oxygen (amoles)",
       color = "Init. Pop.") +
  theme(text=element_text(size=16))

+
  theme_minimal()


p <- ggplot(all_pop, aes(x = Time, y = Population, color = as.factor(init_pop))) +
  geom_line(linewidth=1) +
  #geom_smooth(method = "loess", se = FALSE)+
  labs(title = "Cell Population Size Over Time",
       x = "Time (Days)",
       y = "Population",
       color = "Ini Pop.") +
  theme(text=element_text(size=16))

+
  theme_minimal()


#Plot all Normal cells

n <- ggplot(all_pop, aes(x = Time, y = N_pop, color = as.factor(init_pop))) +
  geom_line(linewidth=1) +
  #geom_smooth(method = "loess", se = FALSE)+
  labs(title = "Normal Cell Population",
       x = "Time (Days)",
       y = "Population",
       color = "Init. Pop.") +
  theme(text=element_text(size=14))


#Plot all cancer  cells
c <- ggplot(all_pop, aes(x = Time, y = C_pop, color = as.factor(init_pop))) +
  geom_line(linewidth=1) +
  #geom_smooth(method = "loess", se = FALSE)+
  labs(title = "Cancer Cell Population",
       x = "Time (Days)",
       y = "Population",
       color = "Init. Pop.") +
  theme(text=element_text(size=14))

##########################################################################################





 Allpop<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_2000,mapping = aes(y = Population, color = "2000"), size = 1.5) +
   geom_line(data=df_1500,mapping = aes(y = Population, color = "1500"), size = 1) +
   geom_line(data=df_1000,mapping = aes(y = Population, color = "1000"), size = 1) +
   geom_line(data=df_500,mapping = aes(y = Population, color = "500"), size = 1) +
   geom_line(data=df_300,mapping = aes(y = Population, color = "300"), size = 1) +
   geom_line(data=df_200,mapping = aes(y = Population, color = "200"), size = 1) +
   geom_line(data=df_100,mapping = aes(y = Population, color = "100"), size = 1) +
   geom_line(data=df_80,mapping = aes(y = Population, color = "80"), size = 1) +
   geom_line(data=df_50,mapping = aes(y = Population, color = "50"), size = 1) +
   geom_line(data=df_20,mapping = aes(y = Population, color = "20"), size = 1) +
   geom_line(data=df_10,mapping = aes(y = Population, color = "10"), size = 1) +
  labs(x = "Time", y = " Population", title = "Population sizes ",color="Initial O2") +
   scale_color_manual(values = c("2000" = "red", "1500" = "darkblue","1000" = "blue", "500" = "darkgreen", "300" = "green",  "200" = "purple", "100" = "violet", "80" = "yellow", "50" = "orange", "20" = "brown", "10" = "pink"), breaks = c("2000", "1500", "1000", "500", "300", "200", "100", "80", "50", "20", "10"))
  +
  theme(text = element_text(size = 16))


   
    
     Allo<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_2000,mapping = aes(y = oxygen, color = "2000"), size = 1.5) +
   geom_line(data=df_1500,mapping = aes(y = oxygen, color = "1500"), size = 1) +
   geom_line(data=df_1000,mapping = aes(y = oxygen, color = "1000"), size = 1) +
   geom_line(data=df_500,mapping = aes(y = oxygen, color = "500"), size = 1) +
   geom_line(data=df_300,mapping = aes(y = oxygen, color = "300"), size = 1) +
   geom_line(data=df_200,mapping = aes(y = oxygen, color = "200"), size = 1) +
   geom_line(data=df_100,mapping = aes(y = oxygen, color = "100"), size = 1) +
   geom_line(data=df_80,mapping = aes(y = oxygen, color = "80"), size = 1) +
   geom_line(data=df_50,mapping = aes(y = oxygen, color = "50"), size = 1) +
   geom_line(data=df_20,mapping = aes(y = oxygen, color = "20"), size = 1) +
   geom_line(data=df_10,mapping = aes(y = oxygen, color = "10"), size = 1) +
  labs(x = "Time (days)", y = " Oxygen Conc. (amoles)", title = "Oxygen Concentration ",color="Initial O2") +
       scale_color_manual(values = c("2000" = "red", "1500" = "darkblue", "1000" = "blue", "500" = "darkgreen", "300" = "green",  "200" = "purple", "100" = "violet", "80" = "yellow", "50" = "orange", "20" = "brown", "10" = "pink"),
 breaks = c("2000", "1500", "1000", "500", "300", "200", "100", "80", "50", "20", "10")) +
  theme(text = element_text(size = 16))
 
 

     

AllNpop<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_2000,mapping = aes(y = N_pop, color = "2000"), size = 1.5) +
   geom_line(data=df_1500,mapping = aes(y = N_pop, color = "1500"), size = 1) +
   geom_line(data=df_1000,mapping = aes(y = N_pop, color = "1000"), size = 1) +
   geom_line(data=df_500,mapping = aes(y = N_pop, color = "500"), size = 1) +
   geom_line(data=df_300,mapping = aes(y = N_pop, color = "300"), size = 1) +
   geom_line(data=df_200,mapping = aes(y = N_pop, color = "200"), size = 1) +
   geom_line(data=df_100,mapping = aes(y = N_pop, color = "100"), size = 1) +
   geom_line(data=df_80,mapping = aes(y = N_pop, color = "80"), size = 1) +
   geom_line(data=df_50,mapping = aes(y = N_pop, color = "50"), size = 1) +
   geom_line(data=df_20,mapping = aes(y = N_pop, color = "20"), size = 1) +
   geom_line(data=df_10,mapping = aes(y = N_pop, color = "10"), size = 1) +
  labs(x = "Time (days)", y = " Population", title = "Normal Cell population ",color="Initial O2")+
  scale_color_manual(values = c("2000" = "red", "1500" = "darkblue", "1000" = "blue", "500" = "darkgreen", "300" = "green",  "200" = "purple", "100" = "violet", "80" = "yellow", "50" = "orange", "20" = "brown", "10" = "pink"),
 breaks = c("2000", "1500", "1000", "500", "300", "200", "100", "80", "50", "20", "10")) +
  theme(text = element_text(size = 16))


AllCpop<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_2000,mapping = aes(y = C_pop, color = "2000"), size = 1.5) +
   geom_line(data=df_1500,mapping = aes(y = C_pop, color = "1500"), size = 1) +
   geom_line(data=df_1000,mapping = aes(y = C_pop, color = "1000"), size = 1) +
   geom_line(data=df_500,mapping = aes(y = C_pop, color = "500"), size = 1) +
   geom_line(data=df_300,mapping = aes(y = C_pop, color = "300"), size = 1) +
   geom_line(data=df_200,mapping = aes(y = C_pop, color = "200"), size = 1) +
   geom_line(data=df_100,mapping = aes(y = C_pop, color = "100"), size = 1) +
   geom_line(data=df_80,mapping = aes(y = C_pop, color = "80"), size = 1) +
   geom_line(data=df_50,mapping = aes(y = C_pop, color = "50"), size = 1) +
   geom_line(data=df_20,mapping = aes(y = C_pop, color = "20"), size = 1) +
   geom_line(data=df_10,mapping = aes(y = C_pop, color = "10"), size = 1) +
  labs(x = "Time (days)", y = " Population", title = "Cancer Cell population ",color="Initial O2")+
  scale_color_manual(values = c("2000" = "red", "1500" = "darkblue", "1000" = "blue", "500" = "darkgreen", "300" = "green",  "200" = "purple", "100" = "violet", "80" = "yellow", "50" = "orange", "20" = "brown", "10" = "pink"),
 breaks = c("2000", "1500", "1000", "500", "300", "200", "100", "80", "50", "20", "10")) +
  theme(text = element_text(size = 16))


  AllCpop+theme(text=element_text(size=16)) 

AllTurnover<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_2000,mapping = aes(y = turnOver2, color = "2000"), size = 1.5) +
   geom_line(data=df_1500,mapping = aes(y = turnOver2, color = "1500"), size = 1) +
   geom_line(data=df_1000,mapping = aes(y = turnOver2, color = "1000"), size = 1) +
   geom_line(data=df_500,mapping = aes(y = turnOver2, color = "500"), size = 1) +
   geom_line(data=df_300,mapping = aes(y = turnOver2, color = "300"), size = 1) +
   geom_line(data=df_200,mapping = aes(y = turnOver2, color = "200"), size = 1) +
  geom_line(data=df_100,mapping = aes(y = turnOver2, color = "100"), size = 1) +
  geom_line(data=df_80,mapping = aes(y = turnOver2, color = "80"), size = 1) +
  geom_line(data=df_50,mapping = aes(y = turnOver2, color = "50"), size = 1) +
  geom_line(data=df_20,mapping = aes(y = turnOver2, color = "20"), size = 1) +
  geom_line(data=df_10,mapping = aes(y = turnOver2, color = "10"), size = 1) +
  labs(x = "Time (days)", y = " Turnover", title = "Net Growth Rate ",color="Initial O2")+
  scale_color_manual(values = c("2000" = "red", "1500" = "darkblue", "1000" = "blue", "500" = "darkgreen", "300" = "green",  "200" = "purple", "100" = "violet", "80" = "yellow", "50" = "orange", "20" = "brown", "10" = "pink"),
 breaks = c("2000", "1500", "1000", "500", "300", "200", "100", "80", "50", "20", "10")) +
  theme(text = element_text(size = 16))

  
  
AllAvgo<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_2000,mapping = aes(y = avg_oxygen, color = "2000"), size = 1.5) +
   geom_line(data=df_1500,mapping = aes(y = avg_oxygen, color = "1500"), size = 1) +
   geom_line(data=df_1000,mapping = aes(y = avg_oxygen, color = "1000"), size = 1) +
   geom_line(data=df_500,mapping = aes(y = avg_oxygen, color = "500"), size = 1) +
   geom_line(data=df_300,mapping = aes(y = avg_oxygen, color = "300"), size = 1) +
   geom_line(data=df_200,mapping = aes(y = avg_oxygen, color = "200"), size = 1) +
  geom_line(data=df_100,mapping = aes(y = avg_oxygen, color = "100"), size = 1) +
  geom_line(data=df_80,mapping = aes(y = avg_oxygen, color = "80"), size = 1) +
  geom_line(data=df_50,mapping = aes(y = avg_oxygen, color = "50"), size = 1) +
  geom_line(data=df_20,mapping = aes(y = avg_oxygen, color = "20"), size = 1) +
  geom_line(data=df_10,mapping = aes(y = avg_oxygen, color = "10"), size = 1) +
  labs(x = "Time (days)", y = " Average oxygen", title = "Average oxygen concentration per grid Cell ",color="Initial O2")+ 
  scale_color_manual(values = c("2000" = "red", "1500" = "darkblue", "1000" = "blue", "500" = "darkgreen", "300" = "green",  "200" = "purple", "100" = "violet", "80" = "yellow", "50" = "orange", "20" = "brown", "10" = "pink"),
 breaks = c("2000", "1500", "1000", "500", "300", "200", "100", "80", "50", "20", "10")) +
  theme(text = element_text(size = 16))

  
  
  
  ##################






 Allpop<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_f3250,mapping = aes(y = Population, color = "3250"), size = 1.5) +
   geom_line(data=df_f3000,mapping = aes(y = Population, color = "3000"), size = 1) +
   geom_line(data=df_f2750,mapping = aes(y = Population, color = "2750"), size = 1) +
   geom_line(data=df_f2500,mapping = aes(y = Population, color = "2500"), size = 1) +
   geom_line(data=df_f2250,mapping = aes(y = Population, color = "2250"), size = 1) +
   geom_line(data=df_f2000,mapping = aes(y = Population, color = "1000"), size = 1) +
   geom_line(data=df_f1750,mapping = aes(y = Population, color = "1750"), size = 1) +
   geom_line(data=df_f1500,mapping = aes(y = Population, color = "1500"), size = 1) +
   geom_line(data=df_f1250,mapping = aes(y = Population, color = "1250"), size = 1) +
   geom_line(data=df_f1000,mapping = aes(y = Population, color = "1000"), size = 1) +
   geom_line(data=df_f750,mapping = aes(y = Population, color = "750"), size = 1) +
  geom_line(data=df_f500,mapping = aes(y = Population, color = "500"), size = 1) +
  geom_line(data=df_f250,mapping = aes(y = Population, color = "250"), size = 1) +
  labs(x = "Time (days)", y = " Population", title = "Population sizes ",color="Oxygen flux") +
   scale_color_manual(values = c("3250" = "red", "3000" = "darkblue", "2750" = "blue", "2500" = "deepskyblue", "2250" = "green",  "2000" = "darkgreen" , "1750" = "purple", "1500" = "violet", "1250" ="yellow", "1000" = "orange" , "750" ="brown", "500"= "darkcyan" ,"250"="magenta"),
 breaks = c("3250", "3000", "2750", "2500", "2250", "2000", "1750", "1500", "1250", "1000", "750","500","250")) +
  theme(text = element_text(size = 16))


   
    
     Allo<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_f3250,mapping = aes(y = oxygen, color = "3250"), size = 1.5) +
   geom_line(data=df_f3000,mapping = aes(y = oxygen, color = "3000"), size = 1) +
   geom_line(data=df_f2750,mapping = aes(y = oxygen, color = "2750"), size = 1) +
   geom_line(data=df_f2500,mapping = aes(y = oxygen, color = "2500"), size = 1) +
   geom_line(data=df_f2250,mapping = aes(y = oxygen, color = "2250"), size = 1) +
   geom_line(data=df_f2000,mapping = aes(y = oxygen, color = "1000"), size = 1) +
   geom_line(data=df_f1750,mapping = aes(y = oxygen, color = "1750"), size = 1) +
   geom_line(data=df_f1500,mapping = aes(y = oxygen, color = "1500"), size = 1) +
   geom_line(data=df_f1250,mapping = aes(y = oxygen, color = "1250"), size = 1) +
   geom_line(data=df_f1000,mapping = aes(y = oxygen, color = "1000"), size = 1) +
   geom_line(data=df_f750,mapping = aes(y = oxygen, color = "750"), size = 1) +
  geom_line(data=df_f500,mapping = aes(y = oxygen, color = "500"), size = 1) +
  geom_line(data=df_f250,mapping = aes(y = oxygen, color = "250"), size = 1) +
  labs(x = "Time (days)", y = " Oxygen Conc. (amoles)", title = "Oxygen profile ",color="Oxygen flux") +
   scale_color_manual(values = c("3250" = "red", "3000" = "darkblue", "2750" = "blue", "2500" = "deepskyblue", "2250" = "green",  "2000" = "darkgreen" , "1750" = "purple", "1500" = "violet", "1250" ="yellow", "1000" = "orange" , "750" ="brown", "500"= "darkcyan" ,"250"="magenta"),
 breaks = c("3250", "3000", "2750", "2500", "2250", "2000", "1750", "1500", "1250", "1000", "750","500","250")) +
  theme(text = element_text(size = 16))
 
 

     

 AllNpop<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_f3250,mapping = aes(y = N_pop, color = "3250"), size = 1.5) +
   geom_line(data=df_f3000,mapping = aes(y = N_pop, color = "3000"), size = 1) +
   geom_line(data=df_f2750,mapping = aes(y = N_pop, color = "2750"), size = 1) +
   geom_line(data=df_f2500,mapping = aes(y = N_pop, color = "2500"), size = 1) +
   geom_line(data=df_f2250,mapping = aes(y = N_pop, color = "2250"), size = 1) +
   geom_line(data=df_f2000,mapping = aes(y = N_pop, color = "1000"), size = 1) +
   geom_line(data=df_f1750,mapping = aes(y = N_pop, color = "1750"), size = 1) +
   geom_line(data=df_f1500,mapping = aes(y = N_pop, color = "1500"), size = 1) +
   geom_line(data=df_f1250,mapping = aes(y = N_pop, color = "1250"), size = 1) +
   geom_line(data=df_f1000,mapping = aes(y = N_pop, color = "1000"), size = 1) +
   geom_line(data=df_f750,mapping = aes(y = N_pop, color = "750"), size = 1) +
  geom_line(data=df_f500,mapping = aes(y = N_pop, color = "500"), size = 1) +
  geom_line(data=df_f250,mapping = aes(y = N_pop, color = "250"), size = 1) +
  labs(x = "Time (days)", y = " Popluation", title = "Normal Population",color="Oxygen flux") +
   scale_color_manual(values = c("3250" = "red", "3000" = "darkblue", "2750" = "blue", "2500" = "deepskyblue", "2250" = "green",  "2000" = "darkgreen" , "1750" = "purple", "1500" = "violet", "1250" ="yellow", "1000" = "orange" , "750" ="brown", "500"= "darkcyan" ,"250"="magenta"),
 breaks = c("3250", "3000", "2750", "2500", "2250", "2000", "1750", "1500", "1250", "1000", "750","500","250")) +
  theme(text = element_text(size = 16))


 AllCpop<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_f3250,mapping = aes(y = C_pop, color = "3250"), size = 1.5) +
   geom_line(data=df_f3000,mapping = aes(y = C_pop, color = "3000"), size = 1) +
   geom_line(data=df_f2750,mapping = aes(y = C_pop, color = "2750"), size = 1) +
   geom_line(data=df_f2500,mapping = aes(y = C_pop, color = "2500"), size = 1) +
   geom_line(data=df_f2250,mapping = aes(y = C_pop, color = "2250"), size = 1) +
   geom_line(data=df_f2000,mapping = aes(y = C_pop, color = "1000"), size = 1) +
   geom_line(data=df_f1750,mapping = aes(y = C_pop, color = "1750"), size = 1) +
   geom_line(data=df_f1500,mapping = aes(y = C_pop, color = "1500"), size = 1) +
   geom_line(data=df_f1250,mapping = aes(y = C_pop, color = "1250"), size = 1) +
   geom_line(data=df_f1000,mapping = aes(y = C_pop, color = "1000"), size = 1) +
   geom_line(data=df_f750,mapping = aes(y = C_pop, color = "750"), size = 1) +
  geom_line(data=df_f500,mapping = aes(y = C_pop, color = "500"), size = 1) +
  geom_line(data=df_f250,mapping = aes(y = C_pop, color = "250"), size = 1) +
  labs(x = "Time (days)", y = " Popluation", title = "Cancer Population",color="Oxygen flux") +
   scale_color_manual(values = c("3250" = "red", "3000" = "darkblue", "2750" = "blue", "2500" = "deepskyblue", "2250" = "green",  "2000" = "darkgreen" , "1750" = "purple", "1500" = "violet", "1250" ="yellow", "1000" = "orange" , "750" ="brown", "500"= "darkcyan" ,"250"="magenta"),
 breaks = c("3250", "3000", "2750", "2500", "2250", "2000", "1750", "1500", "1250", "1000", "750","500","250")) +
  theme(text = element_text(size = 16))


  AllTurnover<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_f3250,mapping = aes(y = turnOver2, color = "3250"), size = 1.5) +
   geom_line(data=df_f3000,mapping = aes(y = turnOver2, color = "3000"), size = 1) +
   geom_line(data=df_f2750,mapping = aes(y = turnOver2, color = "2750"), size = 1) +
   geom_line(data=df_f2500,mapping = aes(y = turnOver2, color = "2500"), size = 1) +
   geom_line(data=df_f2250,mapping = aes(y = turnOver2, color = "2250"), size = 1) +
   geom_line(data=df_f2000,mapping = aes(y = turnOver2, color = "1000"), size = 1) +
   geom_line(data=df_f1750,mapping = aes(y = turnOver2, color = "1750"), size = 1) +
   geom_line(data=df_f1500,mapping = aes(y = turnOver2, color = "1500"), size = 1) +
   geom_line(data=df_f1250,mapping = aes(y = turnOver2, color = "1250"), size = 1) +
   geom_line(data=df_f1000,mapping = aes(y = turnOver2, color = "1000"), size = 1) +
   geom_line(data=df_f750,mapping = aes(y = turnOver2, color = "750"), size = 1) +
  geom_line(data=df_f500,mapping = aes(y = turnOver2, color = "500"), size = 1) +
  geom_line(data=df_f250,mapping = aes(y = turnOver2, color = "250"), size = 1) +
  labs(x = "Time (days)", y = " Turnover", title = "Turnover Rate",color="Oxygen flux") +
   scale_color_manual(values = c("3250" = "red", "3000" = "darkblue", "2750" = "blue", "2500" = "deepskyblue", "2250" = "green",  "2000" = "darkgreen" , "1750" = "purple", "1500" = "violet", "1250" ="yellow", "1000" = "orange" , "750" ="brown", "500"= "darkcyan" ,"250"="magenta"),
 breaks = c("3250", "3000", "2750", "2500", "2250", "2000", "1750", "1500", "1250", "1000", "750","500","250")) +
  theme(text = element_text(size = 16))
  
  
   AllAvgo<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_f3250,mapping = aes(y = avg_oxygen, color = "3250"), size = 1.5) +
   geom_line(data=df_f3000,mapping = aes(y = avg_oxygen, color = "3000"), size = 1) +
   geom_line(data=df_f2750,mapping = aes(y = avg_oxygen, color = "2750"), size = 1) +
   geom_line(data=df_f2500,mapping = aes(y = avg_oxygen, color = "2500"), size = 1) +
   geom_line(data=df_f2250,mapping = aes(y = avg_oxygen, color = "2250"), size = 1) +
   geom_line(data=df_f2000,mapping = aes(y = avg_oxygen, color = "1000"), size = 1) +
   geom_line(data=df_f1750,mapping = aes(y = avg_oxygen, color = "1750"), size = 1) +
   geom_line(data=df_f1500,mapping = aes(y = avg_oxygen, color = "1500"), size = 1) +
   geom_line(data=df_f1250,mapping = aes(y = avg_oxygen, color = "1250"), size = 1) +
   geom_line(data=df_f1000,mapping = aes(y = avg_oxygen, color = "1000"), size = 1) +
   geom_line(data=df_f750,mapping = aes(y = avg_oxygen, color = "750"), size = 1) +
  geom_line(data=df_f500,mapping = aes(y = avg_oxygen, color = "500"), size = 1) +
  geom_line(data=df_f250,mapping = aes(y = avg_oxygen, color = "250"), size = 1) +
  labs(x = "Time (days)", y = " Oxygen Conc. (amoles) ", title = "Average Concentration per rid Cell",color="Oxygen flux") +
   scale_color_manual(values = c("3250" = "red", "3000" = "darkblue", "2750" = "blue", "2500" = "deepskyblue", "2250" = "green",  "2000" = "darkgreen" , "1750" = "purple", "1500" = "violet", "1250" ="yellow", "1000" = "orange" , "750" ="brown", "500"= "darkcyan" ,"250"="magenta"),
 breaks = c("3250", "3000", "2750", "2500", "2250", "2000", "1750", "1500", "1250", "1000", "750","500","250")) +
  theme(text = element_text(size = 16))

################################
   
   
   Allpop<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_b3500,mapping = aes(y = Population, color = "3500"), size = 1.5) +
   geom_line(data=df_b1000,mapping = aes(y = Population, color = "1000"), size = 1) +
   geom_line(data=df_b500,mapping = aes(y = Population, color = "500"), size = 1) +
   geom_line(data=df_b300,mapping = aes(y = Population, color = "300"), size = 1) +
  labs(x = "Time (days)", y = " Population", title = "Population sizes ",color="Max  vssl O2") +
   scale_color_manual(values = c("3500" = "red", "1000" = "darkblue", "500" = "green",  "300" = "purple"),
 breaks = c("3500", "1000", "500", "300")) +
  theme(text = element_text(size = 16))
   
   
   
   
   
     Allo<-ggplot(NULL, aes(x = Time)) +
   geom_line(data=df_b3500,mapping = aes(y = oxygen, color = "3500"), size = 1.5) +
   geom_line(data=df_b1000,mapping = aes(y = oxygen, color = "1000"), size = 1) +
   geom_line(data=df_b500,mapping = aes(y = oxygen, color = "500"), size = 1) +
   geom_line(data=df_b300,mapping = aes(y = oxygen, color = "300"), size = 1) +
  labs(x = "Time (days)", y = " oxygen", title = "Total oxygen Concentration ",color="Max  vssl O2") +
   scale_color_manual(values = c("3500" = "red", "1000" = "darkblue", "500" = "green",  "300" = "purple"),
 breaks = c("3500", "1000", "500", "300")) +
  theme(text = element_text(size = 16))
   
   
   
   

 combined_pop_oxy<-ggarrange( Allpop,Allo,
                      #labels = c(" "," ",), #"Growth", "Death", "Popuation","Oxygen"), # Optional labels for the subplots
                      ncol = 2, nrow = 1, # Arrange in a 2x2 grid
                       label.x = 0, # Horizontal position of the labels (centered)
                     label.y = .8,
  common.legend = FALSE
)
  
  
  
  combined_nor_Can<-ggarrange( AllNpop,AllCpop,
                      #labels = c(" "," ",), #"Growth", "Death", "Popuation","Oxygen"), # Optional labels for the subplots
                      ncol = 2, nrow = 1, # Arrange in a 2x2 grid
                       label.x = 0, # Horizontal position of the labels (centered)
                     label.y = .8,
  common.legend = FALSE
) 
  











allCombined2<-ggarrange( Allpop,Allo,AllNpop, AllCpop,AllTurnover,
                      #labels = c(" "," "," "," "," "," "), #"Growth", "Death", "Popuation","Oxygen"), # Optional labels for the subplots
                      ncol = 2, nrow = 3, # Arrange in a 2x2 grid
                       label.x = 0, # Horizontal position of the labels (centered)
                     label.y = .8,
  common.legend = FALSE
)


o1<-ggplot(cell_df, aes(x=Time)) +
  geom_line(mapping=aes(y=Oxygen),color="purple",size=1)+
  #geom_vline(xintercept=1,linetype="dashed",color="red",size=.8)+
  labs(x="Time", y="Total oxygen concentration (amoles)")
  

o2<-ggplot(cell_df, aes(x=Time)) +
  geom_line(mapping=aes(y=avg_oxygen),color="purple",size=1)+
  geom_vline(xintercept=1,linetype="dashed",color="red",size=.8)+
  labs(x="Time", y="Total oxygen concentration (amoles)")

  

df_normalized<-cell_df
  
df_normalized$N_deathRate<-normalize(df_normalized$N_deathRate)
df_normalized$C_deathRate<-normalize(df_normalized$C_deathRate)

 p3<-ggplot(df_normalized, aes(x = Time)) +
    geom_line(mapping = aes(y = N_pop, color = "Normal"), size = 1) +
    geom_line(mapping = aes(y = C_pop, color = "Cancer"), size = 1) +
  labs(x = "Time", y = " Population Size", title = "Population",color="Size")
  
  
 
 
 p + annotate("text", x = 0, y = 2, label = "y = \\frac{a}{b} \\times x + c", parse = TRUE, size = 5)
 
 
 

cells_data<-cell_df
  
    











    
     q1<-ggplot(NULL, aes(x = Time)) +
    geom_line(data=diff_0.79,mapping = aes(y = N_pop, color = "Normal"), size = 1) +
    geom_line(data=diff_0.79,mapping = aes(y = C_pop, color = "Cancer"), size = 1) +
  labs(x = "Time", y = " Population Size", title = "Population",color="Size")
  
    q2<-ggplot(NULL, aes(x = Time)) +
    geom_line(data=dif_0.78,mapping = aes(y = N_pop, color = "Normal"), size = 1) +
    geom_line(data=dif_0.78,mapping = aes(y = C_pop, color = "Cancer"), size = 1) +
  labs(x = "Time", y = " Population Size", title = "Population",color="Size")
  
  
    q3<-ggplot(NULL, aes(x = Time)) +
    geom_line(data=diff_0.77,mapping = aes(y = N_pop, color = "Normal"), size = 1) +
      geom_line(data=diff_0.77,mapping = aes(y = C_pop, color = "Cancer"), size = 1) +
  labs(x = "Time", y = " Population Size", title = "Population",color="Size")
  
    q4<-ggplot(NULL, aes(x = Time)) +
    geom_line(data=diff_0.76,mapping = aes(y = N_pop, color = "Normal"), size = 1) +
      geom_line(data=diff_0.76,mapping = aes(y = C_pop, color = "Cancer"), size = 1) +
  labs(x = "Time", y = " Population Size", title = "Population",color="Size")
    
    
    cm<-ggarrange(q1,q2,q3, q4,
                      labels = c("death rate=0.79", "death rate=0.78", "death rate=0.77","death rate=0.76"), # Optional labels for the subplots
                      ncol = 2, nrow = 2, # Arrange in a 2x2 grid
                  label.x = 0.1, # Horizontal position of the labels (centered)
                 label.y = .8,
  common.legend = FALSE)
    
    
    
  
 theme(
  legend.position = c(1, 1),
  legend.justification = c(1, 1),
  legend.box.just = "left",
  legend.background = element_rect(fill = "gray"),
  legend.text = element_text(size = 16)
  )
  theme_minimal()
  
 p+theme(text=element_text(size=14))
 
 #### this is the model of death rate that we are using now
 natural_deathRate <- 0.056

# Define the function
f <- function(x) { natural_deathRate + 0.3 / (1 + x) }

# Generate data for plotting
x <- seq(0, 10, length.out = 1000)
y <- f(x)
data <- data.frame(x, y)

# Create the plot
q <- ggplot(data, aes(x, y),Size=2.5) +
  geom_line(color = "blue") +
  geom_hline(yintercept = natural_deathRate , linetype = "dashed", color = "red",size=1.5) +  # Add horizontal line
  labs(
    x = "Oxygen concentration",
    y = "Death rate"
  ) +
  theme_minimal()

# Annotate with mathematical expression
q + annotate("text", x = 6, y = 0.85,
             label =  "Death_Rate",
             parse = TRUE, size = 5)


```

The next code is used to check different random numbers generated under different seeds
```{r}

seed<-as.matrix(read.csv("/Users/4477116/Documents/projects/Ploidy_abm/output/random.csv",header=FALSE))
seed1<-as.matrix(read.csv("/Users/4477116/Documents/projects/Ploidy_abm/output/random1.csv",header=FALSE))
which(seed!=seed1)




Mseed<-as.matrix(read.csv("/Users/4477116/Documents/projects/Ploidy_abm/output/Mrandom.csv",header=FALSE))
Mseed1<-as.matrix(read.csv("/Users/4477116/Documents/projects/Ploidy_abm/output/Mrandom1.csv",header=FALSE))

length(which(Mseed[1:1000]==Mseed1[1:1000]))



which(Mseed!=Mseed1)
```


```{r}
###########################################################################################
#### Hypothesis: Regions dominated by Cancer cells will exhibit altered resource  #########
#### distribution due to   differences in resource uptake                         #########
###########################################################################################


# Assuming your matrix is named 'mat'


maindir<-"/Users/4477116/Documents/projects/Ploidy_abm/output"
xDim=200
yDim=200

readCancerCellLoc=function(mypath){# Return all those cell location occupied by cancer cells

mat<-as.matrix(read.csv(mypath,header=FALSE))
mat<-mat[!(mat[,1]==0 & mat[,2]==0),] #Extrac locations with cells

rows_with_non_2 <- apply(mat[, 3:24], 1, function(x) any(x != 2))

# Extract columns 1 and 2 for these rows
Cancer_Cells_locations <- mat[rows_with_non_2, 1:2]

colnames(Cancer_Cells_locations)=NULL
return (Cancer_Cells_locations)

}

 index<-readCancerCellLoc(paste0(maindir,"/3000_karyotype_Location.csv"))
 
 
readO2Data=function(mypath2){  #Return stretched Oxygen concentration matrix (M by 3)

index<-index+1 # indexing in java starts from zero

row_col_indices <- expand.grid(row = 1:200, col = 1:200)


mat2<-as.matrix(read.csv(mypath2,header=FALSE))

O2matrix<-cbind(row_col_indices, value=as.vector(mat2))

#return(list("cancer_index"=Cancer_Cells_locations,"normal_locations"= normal_location))
return(O2matrix)
}



O2data<-readO2Data(paste0(maindir,"/O2/3000_O2Distribution.csv"))


o2<-ggplot(O2data, aes(x = row, y = col, fill = value)) +
  geom_tile() +
  #geom_vline(xintercept = 0.03,size=1.5,color="green") +
 # geom_hline(yintercept = 0.026,size=1.5,color="green") +
  #scale_x_continuous(breaks = 0.03) +
  #scale_y_continuous(breaks = 0.026) +
  scale_fill_gradient(low = "blue", high = "red") +
  labs(title = "Oxygen (amoles)",
       x = "X",
       y = "Y",
       fill = "Oxygen") +
  theme_minimal() +
  theme(text = element_text(size = 16))


getO2atCancerLoc=function(indices,O2Matrix){ #Returns total O2 at all cancer cell spots
matching_rows <- apply(indices, 1, function(row) {
  which(O2Matrix[, 1] == row[1] & O2Matrix[, 2] == row[2])
})
matching_rows <- unique(unlist(matching_rows))

returnMatrix<-O2Matrix[matching_rows, ]

concAtCancerLoc<-O2Matrix[matching_rows,]
O2AtCancerLoc<-sum(returnMatrix[,3])
return(list("CancerSpots"=returnMatrix,"O2AtCancerSpots"=O2AtCancerLoc))
}

cancerLoc<-getCancerLoc(index,cancer_normal_loc)


O2files<-list.files(paste0(maindir,"/O2"),pattern=paste0(".*","_O2Distribution", ".*\\.csv$"))
cellfiles<-list.files(maindir,pattern=paste0(".*","_karyotype_Location", ".*\\.csv$"))
#Re-order list of files to match timepoints
O2files<-O2files[order(as.numeric(sub("([0-9]*).*","\\1",O2files)))]
cellfiles<-cellfiles[order(as.numeric(sub("([0-9]*).*","\\1",cellfiles)))]

Oxygen<-c()
for(i in 1:length(O2files)){
   cancerIndex<-readCancerCellLoc(paste0(maindir,"/",cellfiles[i]))
   O2matrix<- readO2Data(paste0(maindir,"/O2/",O2files[i]))
   O2_At_cancer_loc<-getO2atCancerLoc(cancerIndex,O2matrix)
  Oxygen<-c(Oxygen, O2_At_cancer_loc$O2AtCancerSpots)
}




```



```{r}

#Various model of the ABM


####### DEATH ######
# Define the parameters
Dn <- 0.043   # Natural death rate (minimum death rate)
Dmax <- 1    # Maximum death rate
Km <- 0.002     # Michaelis constant

# Define the Michaelis-Menten death rate function
#death_rate <- function(O2, Dn, Dmax, Km) {
#  Dn + (Dmax - O2) * (1 / (Km + O2))
#}

#death_rate <- function(O2, Dn, Dmax, Km) {
#  Dn + (Dmax - Dn) / (1 + O2/Km)
#}

#Revised
death_rate <- function(O2, Dn, Dmax, Km) {
  Dn* (1-(O2 / (O2+ Km)))
}

# Generate sample data for oxygen concentrations
oxygen_concentration <- seq(0.0001, 0.061, by=0.0001)

# Calculate the death rates for the sample data
death_rates <- death_rate(oxygen_concentration, Dn, Dmax, Km)

# Create a data frame for plotting
ddata <- data.frame(Oxygen = oxygen_concentration, DeathRate = death_rates)

# Plot the data
dr<-ggplot(ddata, aes(x = Oxygen, y = DeathRate)) +
  geom_line(color = 'blue', size = 1) +
  geom_vline(xintercept=Km,linetype = "dashed", color = "red", size = 1)
  labs(title = 'Cell Death Rate',
       x = 'Oxygen Concentration',
       y = 'Death Rate') +
    ylim(0,1)+
  theme(text=element_text(size=16))



# Plot the data
dr<-ggplot(NULL, ) +
  geom_line(data=ddata,aes(x = Oxygen, y = DeathRate,color = 'Original'), linewidth = 1.5) +
  geom_line(data=revised,aes(x = Oxygen, y = DeathRate,color="Revised"),linewidth=1.5)+
   geom_vline(xintercept=Km,linetype = "dashed", color = "red", size = 1)+
  scale_y_log10()+
  labs(title = 'Cell Death Rate',
       x = 'Oxygen Con (mmol/L)',
       y = 'Death Rate',
       color="Rates") +
  theme(text=element_text(size=18))



########### CONSUMPTION ########


# Define oxygen concentration range and Michaelis-Menten coefficient
oxygen_concentration <- seq(0, 5000, by = 100)
Vmax <- 4.5    # Maximum consumption rate
Km <- 500      # Michaelis-Menten constant (concentration at half-maximal uptake)

# Michaelis-Menten equation for oxygen consumption
NormalCellConsumption <- (Vmax * oxygen_concentration) / (Km + oxygen_concentration)
CancerCellConsumption<-(Vmax * oxygen_concentration) / (Km + oxygen_concentration)

# Plot the oxygen consumption curve
plot(oxygen_concentration, NormalCellConsumption, type="l", col="blue", lwd=2,
     xlab="Oxygen Concentration", ylab="Oxygen Consumption Rate",
     main="Oxygen Consumption vs. Oxygen Concentration")

con_df<-data.frame("oxygen"=oxygen_concentration,
               "NormalConsumption"=NormalCellConsumption,
               "CancerConsumption"=CancerCellConsumption)


cplot<-ggplot(con_df, aes(x=oxygen))+
             geom_line(mapping=aes(y=NormalConsumption,color="Normal cells"),size=1)+
             geom_line(mapping=aes(y=CancerCellConsumption, color="Cancer cells"),size=1)+
              labs(x="Oxygen concentration", y="Consumption", title="Oxygen consumption for normal and cancer cells                   (amoles)" )+
               theme(text=element_text(size=16))



con_rates<-c(100,30,20, 15, 10, 5,1)
oxygen_concentration <- seq(0, 5000, by = 100)

cdf<-data.frame()
for(j in con_rates){
  Vmax <- j
  # Michaelis-Menten equation for oxygen consumption
NormalCellConsumption <- (Vmax * oxygen_concentration) / (Km + oxygen_concentration)
NormalCellConsumption <-(Vmax * oxygen_concentration) / (Km + oxygen_concentration)
name<-paste0("C",j)
xdf<-data.frame(oxygen_concentration,NormalCellConsumption, NormalCellConsumption) 
xdf$con_rate<-j
cdf<-rbind(cdf,xdf)
}

cdf<-cdf%>%
  mutate(across(everything(),as.numeric))

cp<-ggplot(cdf, aes(x=oxygen_concentration,y=NormalCellConsumption,color=as.factor(con_rate)))+
             geom_line()+
              labs(x="Oxygen concentration", y="Consumption", title="Oxygen consumption for normal and cancer cells                   (amoles)" )+
               theme(text=element_text(size=16))






#REVISED CONSUMPTION 

consumption=function(O2, Vo,Km){
  (Vo*O2)/(O2+Km)
}

oxygen_concentration <- seq(0, 0.061, by=0.0001)
timescalar<-7e-7;
Km<-0.005
Vo=4.5;

con_rate<-consumption(oxygen_concentration,Vo,Km)
con_df<-data.frame(oxygen=oxygen_concentration, consumption=con_rate, scaled_consumption=con_rate*timescalar)

cp<-ggplot(con_df, aes(x=oxygen,y=scaled_consumption))+
             geom_line(color="blue",linewidth=1)+
              labs(x="Oxygen concentration", y="Consumption(per instance)", title="Oxygen consumption" )+
               theme(text=element_text(size=16))



# Plot the data
cp<-ggplot(NULL, ) +
  geom_line(data=con_df,aes(x = oxygen, y = scaled_consumption,color = 'Original (1000)'), linewidth = 1.5) +
  geom_line(data=revised,aes(x = oxygen, y = scaled_consumption,color="Revised (4.5)"),linewidth=1.5)+
   scale_y_log10()+
   geom_vline(xintercept=Km,linetype = "dashed", color = "red", size = 1)+
  labs(title = 'Cell Consumption',
       x = 'Oxygen Con (mmol/L)',
       y = 'Consumption(per instance)',
       color="Rates") +
  theme(text=element_text(size=18))




#Birth and Death together





n <- 1.2  # A Hill coefficient greater than 1 to increase sensitivity
HillConsumption <- (Vmax * oxygen_concentration^n) / (Km^n + oxygen_concentration^n)
alpha <- 0.001  # Linear coefficient
ModifiedConsumption <- (Vmax * oxygen_concentration) / (Km + oxygen_concentration) + alpha * oxygen_concentration
ModifiedCellConsumption2 <- (Vmax * oxygen_concentration) / ((Km + oxygen_concentration)^p)
plot(oxygen_concentration, ModifiedCellConsumption, type = "l", col = "blue", lwd = 2,
     ylab = "Oxygen Consumption Rate", xlab = "Oxygen Concentration", main = "Oxygen Consumption with Hill Equation")
# Plot to visualize the difference
lines(oxygen_concentration, ModifiedCellConsumption2, col = "red", lwd = 2, lty = 2)
legend("bottomright", legend = c("Hill Equation", "Modified Michaelis-Menten"),
       col = c("blue", "red"), lwd = 2, lty = c(1, 2))


```

